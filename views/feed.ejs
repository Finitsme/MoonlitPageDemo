<%- include('partials/header', { title: "ฟีตแนะนำ | MOONLITPAGE" }) %> 
<%-include('partials/navbar', { user: locals.user }) %>

<main class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-7">
      <h1 class="mb-4 text-center">Review Feed</h1>

      <% if (user) { %>
      <div class="card mb-4 shadow-sm">
        <div class="card-body">
          <div
            class="input-group"
            data-bs-toggle="modal"
            data-bs-target="#postReviewModal"
            style="cursor: pointer"
          >
            <span class="input-group-text p-0 border-0 bg-transparent me-2">
              <img
                src="<%= user.profile_pic_url || '/images/default_avatar.png' %>"
                alt="Avatar"
                class="rounded-circle"
                style="width: 40px; height: 40px; object-fit: cover"
              />
            </span>
            <input
              type="text"
              class="form-control rounded-pill"
              placeholder="คุณกำลังคิดอะไรอยู่, <%= user.username_display || user.fullname || user.username %>?"
              aria-label="New Post"
              readonly
              style="cursor: pointer"
            />
          </div>
        </div>
      </div>
      <% } else { %>
      <p class="alert alert-info text-center">
        กรุณา <a href="/login">เข้าสู่ระบบ</a> เพื่อโพสต์รีวิวของคุณ
      </p>
      <% } %>

      <p class="text-muted text-center small mb-5">
        ดูโพสต์และรีวิวล่าสุดจากสมาชิกคนอื่น ๆ ใน MoonlitPage
      </p>

      <% if (reviews.length === 0) { %>
      <div class="alert alert-warning text-center">
        ยังไม่มีรีวิวถูกโพสต์ กรุณาโพสต์รีวิวแรกของคุณ!
      </div>
      <% } else { %> <% reviews.forEach(review => { %> <% const postId =
      review.post_id || review.review_id; const isLiked = review.isLiked ||
      false; const likeCount = review.likeCount || 0; const isBookmarked =
      review.isBookmarked || false; %>
      <div class="card mb-3 shadow-sm review-card">
        <div
          class="card-body"
          data-bs-toggle="modal"
          data-bs-target="#fullPostModal<%= postId %>"
          style="cursor: pointer"
        >
          <div class="d-flex align-items-start mb-3">
            <img
              src="<%= review.profile_pic_url || '/images/default_avatar.png' %>"
              alt="Avatar"
              class="rounded-circle me-3"
              style="width: 45px; height: 45px; object-fit: cover"
            />
            <div>
              <h6 class="mb-0">
                <%= review.username_display || review.username %> <% if
                (review.username_display) { %>
                <span class="text-muted small ms-1"
                  >@<%= review.username %></span
                >
                <% } %>
              </h6>
              <p class="text-muted small m-0">
                โพสต์เมื่อ: <%= new
                Date(review.created_at).toLocaleString('th-TH', { day:
                'numeric', month: 'short', year: 'numeric', hour: '2-digit',
                minute: '2-digit' }) %>
              </p>
            </div>
          </div>

          <p class="card-text review-content mb-3 text-truncate">
            <%= review.content %>
          </p>

          <% if (review.image_url) { %>
          <div class="mb-3">
            <img
              src="<%= review.image_url %>"
              class="img-fluid rounded shadow-sm"
              alt="Review Image"
              style="max-height: 400px; object-fit: cover; width: 100%"
            />
          </div>
          <% } %> <% if (review.bookTitle && review.bookTitle !==
          'ไม่ระบุหนังสือ') { %>
          <div
            class="alert alert-light border-start border-4 border-info p-2 mb-2"
          >
            <i class="fas fa-book me-2 text-info"></i>
            **รีวิวหนังสือ:**
            <a
              href="/book?q=<%= encodeURIComponent(review.book_id) %>"
              class="text-decoration-none text-info"
            >
              <%= review.bookTitle %>
            </a>
          </div>
          <% } %>
        </div>

        <div class="card-footer bg-white pt-2 pb-2 border-top">
          <div class="d-flex justify-content-between">
            <button
              class="btn btn-sm <%= isLiked ? 'btn-danger' : 'btn-outline-secondary' %> like-button"
              data-post-id="<%= postId %>"
              data-interaction-type="LIKE"
            >
              <i class="fa<%= isLiked ? 's' : 'r' %> fa-heart me-1"></i> 
              <span class="like-count"><%= likeCount %></span>
            </button>

            <button
              class="btn btn-sm btn-outline-secondary text-muted comment-button"
              data-bs-toggle="modal"
              data-bs-target="#fullPostModal<%= postId %>"
            >
              <i class="far fa-comment me-1"></i> ความคิดเห็น (<span
                class="comment-count"
                ><%= review.commentCount %></span
              >)
            </button>

            <button
              class="btn btn-sm <%= isBookmarked ? 'btn-info' : 'btn-outline-secondary' %> bookmark-button"
              data-post-id="<%= postId %>"
              data-interaction-type="BOOKMARK"
            >
              <i class="fa<%= isBookmarked ? 's' : 'r' %> fa-bookmark"></i>
            </button>
          </div>
        </div>
      </div>
      <% }); %> <% } %>
    </div>
  </div>
</main>

<div class="modal fade" id="postReviewModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">โพสต์รีวิว/ความคิดเห็นใหม่</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <form action="/feed/post" method="POST" enctype="multipart/form-data">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label"
              >ความคิดเห็นของคุณ (สูงสุด 500 ตัวอักษร)</label
            >
            <textarea
              name="content"
              class="form-control"
              rows="4"
              maxlength="500"
              required
            ></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label">เพิ่มรูปภาพประกอบ (ไม่บังคับ)</label>
            <input
              type="file"
              name="review_image"
              class="form-control"
              accept="image/*"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            ยกเลิก
          </button>
          <button type="submit" class="btn btn-customfeed">โพสต์</button>
        </div>
      </form>
    </div>
  </div>
</div>

<% reviews.forEach(review => { %> <% const postId = review.post_id ||
review.review_id; const isLiked = review.isLiked || false; const isBookmarked =
review.isBookmarked || false; %>
<div class="modal fade" id="fullPostModal<%= postId %>" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          โพสต์โดย <%= review.username_display || review.username %>
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div class="d-flex align-items-center mb-3">
          <img
            src="<%= review.profile_pic_url || '/images/default_avatar.png' %>"
            alt="Avatar"
            class="rounded-circle me-3"
            style="width: 40px; height: 40px; object-fit: cover"
          />
          <div>
            <h6 class="mb-0">
              <%= review.username_display || review.username %>
            </h6>
            <p class="text-muted small m-0">
              <%= new Date(review.created_at).toLocaleString('th-TH') %>
            </p>
          </div>
        </div>

        <p class="fs-5"><%= review.content %></p>

        <% if (review.image_url) { %>
        <div class="my-3">
          <img
            src="<%= review.image_url %>"
            class="img-fluid rounded shadow-sm"
            alt="Review Image"
          />
        </div>
        <% } %> <% if (review.bookTitle && review.bookTitle !==
        'ไม่ระบุหนังสือ') { %>
        <div class="alert alert-info p-2 mt-3">
          <i class="fas fa-book me-2"></i>
          **ป้ายยา:**
          <a
            href="/book?q=<%= encodeURIComponent(review.book_id) %>" //ป้องกันปัญหาชื่อหนังสือหรือค่าที่มีช่องว่าง, อีโมจิ, อักษรไทย, เครื่องหมายพิเศษ
            class="text-decoration-none text-info"
          >
            <%= review.bookTitle %>
          </a>
        </div>
        <% } %>

        <hr />

        <h6>
          ความคิดเห็น (<span id="modalCommentCount<%= postId %>"
            ><%= review.commentCount %></span>)
        </h6>

        <div
          id="commentsList<%= postId %>"
          class="list-group list-group-flush mb-3"
        >
          <% if (review.comments && review.comments.length === 0) { %>
          <div
            class="alert alert-light text-muted small mt-2 no-comments-alert"
          >
            ยังไม่มีความคิดเห็นสำหรับโพสต์นี้
          </div>
          <% } else { %> <% review.comments.forEach(comment => { %>
          <div
            class="list-group-item list-group-item-action p-2 d-flex comment-item"
          >
            <img
              src="<%= comment.profile_pic_url || '/images/default_avatar.png' %>"
              alt="Avatar"
              class="rounded-circle me-2"
              style="width: 30px; height: 30px; object-fit: cover"
            />
            <div>
              <small class="fw-bold text-dark me-1"
                ><%= comment.username_display || comment.username %></small
              >
              <small class="text-muted small"
                ><%= new Date(comment.created_at).toLocaleString('th-TH', {
                dateStyle: 'short', timeStyle: 'short' }) %></small
              >
              <p class="mb-0 small"><%= comment.content %></p>
            </div>
          </div>
          <% }); %> <% } %>
        </div>
        <% if (user) { %>
        <form
          class="d-flex mt-3 comment-form-modal"
          data-post-id="<%= postId %>"
        >
          <input
            type="text"
            class="form-control me-2 comment-input"
            placeholder="แสดงความคิดเห็น..."
          />
          <button class="btn btn-primary" type="submit">ส่ง</button>
        </form>
        <% } %>
      </div>
      <div class="modal-footer justify-content-between">
        <div class="d-flex">
          <button
            class="btn btn-sm <%= isLiked ? 'btn-danger' : 'btn-outline-danger' %> me-2 like-button"
            data-post-id="<%= postId %>"
            data-interaction-type="LIKE"
          >
            <i class="fa<%= isLiked ? 's' : 'r' %> fa-heart me-1"></i> Like
          </button>

          <button
            class="btn btn-sm <%= isBookmarked ? 'btn-info' : 'btn-outline-secondary' %> bookmark-button"
            data-post-id="<%= postId %>"
            data-interaction-type="BOOKMARK"
          >
            <i class="fa<%= isBookmarked ? 's' : 'r' %> fa-bookmark"></i>
            Bookmark
          </button>
        </div>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          ปิด
        </button>
      </div>
    </div>
  </div>
</div>
<% }); %> <%- include('partials/footer') %>

<script> 
  document.addEventListener("DOMContentLoaded", () => { 
    // query like-button, bookmark-button
    const actionButtons = document.querySelectorAll(
      ".like-button, .bookmark-button"
    ); //อให้ HTML ของหน้าเว็บโหลดเสร็จทั้งหมดก่อนที่จะรันโค้ด JavaScript

    // วนลูปปุ่มทั้งหมด
    actionButtons.forEach((button) => {
      button.addEventListener("click", async function (e) {
        e.preventDefault(); // ป้องกันการทำงานเริ่มต้นของปุ่ม
        e.stopPropagation(); // หยุด Event Bubbling

        const type = this.dataset.interactionType; // ดึงชนิด like/bookmark
        const postId = this.dataset.postId; // ดึง postId
        const partnerButtons = document.querySelectorAll(
          `[data-post-id="${postId}"][data-interaction-type="${type}"]`
        ); // query ปุ่มที่มี postId และ type เหมือนกัน

        // เช็คว่า user ล็อกอินอยู่มั้ย
        if (!"<%= locals.user ? true : false %>") {
          alert("กรุณาเข้าสู่ระบบเพื่อทำกิจกรรมนี้");
          return;
        }

        // LIKE
        if (type === "LIKE") {
          try {
            const response = await fetch("/api/post/like", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ postId: postId }),
            });

            const data = await response.json(); // แปลง response ให้เป็น json

            if (data.success) {
              // วนลูป update สถานะของปุ่ม like
              partnerButtons.forEach((btn) => {
                const icon = btn.querySelector("i"); // icon หัวใจ
                const likeCountSpan = btn.querySelector(".like-count"); // จำนวน like

                // ถ้ากด like แล้ว
                if (data.action === "liked") {
                  btn.classList.remove("btn-outline-secondary", "text-muted");
                  btn.classList.add("btn-danger");
                  icon.classList.remove("far"); 
                  icon.classList.add("fas"); // เปลี่ยนจาก outline เป็น solid
                  // update like count +1
                  if (likeCountSpan)
                    likeCountSpan.textContent =
                      parseInt(likeCountSpan.textContent) + 1;
                } else if (data.action === "unliked") { // ถ้า unliked
                  btn.classList.remove("btn-danger", "text-danger");
                  btn.classList.add("btn-outline-secondary", "text-muted");
                  icon.classList.remove("fas"); 
                  icon.classList.add("far"); // เปลี่ยนกลับเป็น outline
                  // update like count -1
                  if (likeCountSpan)
                    likeCountSpan.textContent =
                      parseInt(likeCountSpan.textContent) - 1;
                }
              });
            } else {
              alert("ดำเนินการไม่สำเร็จ: " + (data.error || "Server error"));
            }
          } catch (error) {
            console.error("Fetch Error:", error);
            alert("ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้");
          }
          return;
        }

        // BOOKMARK
        if (type === "BOOKMARK") {
          try {
            // ส่งคำขอไปที่ API สำหรับ toggle bookmark
            const response = await fetch("/api/post/toggle-bookmark", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ postId: postId }),
            });

            const data = await response.json();

            if (data.success) {
              // วนลูป update สถานะของปุ่ม bookmark
              partnerButtons.forEach((btn) => {
                const icon = btn.querySelector("i");
                
                // ถ้ากด add bookmark แล้ว
                if (data.action === "added") {
                  btn.classList.remove("btn-outline-secondary", "text-muted");
                  btn.classList.add("btn-info");
                  icon.classList.remove("far");
                  icon.classList.add("fas"); // เปลี่ยนจาก outline เป็น solid
                  // ถ้ากด remove bookmark
                } else if (data.action === "removed") {
                  btn.classList.remove("btn-info");
                  btn.classList.add("btn-outline-secondary", "text-muted");
                  icon.classList.remove("fas");
                  icon.classList.add("far"); // เปลี่ยนกลับเป็น outline 
                }
              });
            } else {
              alert(
                "ดำเนินการ Bookmark ไม่สำเร็จ: " +
                  (data.error || "Server error")
              );
            }
          } catch (error) {
            console.error("Bookmark Fetch Error:", error);
            alert("ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้");
          }
          return;
        }
      });
    });

    // COMMENT
    document.querySelectorAll(".comment-form-modal").forEach((form) => { // ค้นหา comment form
      form.addEventListener("submit", async function (e) {
        e.preventDefault(); // ป้องกันการโหลดหน้าใหม่

        const postId = this.dataset.postId; // ดึง postId
        const contentInput = this.querySelector(".comment-input"); // เก็บ input comment
        const content = contentInput.value.trim(); // ดึงข้อความ comment + ลบช่องว่าง

        if (!content) return; // ไม่ส่งถ้าไม่มี content

        // เช็คว่า user ล็อกอินอยู่มั้ย
        if (!"<%= locals.user ? true : false %>") {
          alert("กรุณาเข้าสู่ระบบเพื่อแสดงความคิดเห็น");
          return;
        }

        try {
          // ส่งคำขอไปที่ API สำหรับ comment
          const response = await fetch("/api/post/comment", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ postId: postId, content: content }),
          });

          const data = await response.json();

          if (data.success) {
            const commentsList = document.getElementById(
              `commentsList${postId}` // ค้นหา commentList
            );
            const modalCountSpan = document.getElementById(
              `modalCommentCount${postId}` // ค้นหาตัวนับ comment ใน modal
            );
            const feedCountSpans = document.querySelectorAll(
              `.review-card [data-post-id="${postId}"] .comment-count` // ค้นหาตัวนับ comment ใน feed card
            );

            // สร้าง comment 
            const newComment = data.newComment;
            // สร้าง HTML สำหรับ comment ใหม่
            const newCommentHtml = ` 
                            <div class="list-group-item list-group-item-action p-2 d-flex comment-item">
                                <img 
                                    src="${
                                      newComment.profile_pic_url ||
                                      "/images/default_avatar.png"
                                    }" 
                                    alt="Avatar" 
                                    class="rounded-circle me-2" 
                                    style="width: 30px; height: 30px; object-fit: cover;"
                                />
                                <div>
                                    <small class="fw-bold text-dark me-1">${
                                      newComment.username_display ||
                                      newComment.username
                                    }</small>
                                    <small class="text-muted small">เมื่อสักครู่</small>
                                    <p class="mb-0 small">${
                                      newComment.content
                                    }</p>
                                </div>
                            </div>
                        `;

            // ลบ alert "ยังไม่มีความคิดเห็น" 
            const noCommentAlert =
              commentsList.querySelector(".no-comments-alert");
            if (noCommentAlert) noCommentAlert.remove();

            // เพิ่ม comment ใหม่
            commentsList.insertAdjacentHTML("beforeend", newCommentHtml);

            // อัปเดตจำนวน Comment
            if (modalCountSpan) // ใน modal
              modalCountSpan.textContent = data.newCommentCount;
            feedCountSpans.forEach( // ใน feed
              (span) => (span.textContent = data.newCommentCount)
            );

            // เคลียร์ Input
            contentInput.value = "";
          } else {
            alert(
              "ไม่สามารถโพสต์ความคิดเห็นได้: " + (data.error || "Server error")
            );
          }
        } catch (error) {
          console.error("Comment Submit Error:", error);
          alert("เกิดข้อผิดพลาดในการส่งความคิดเห็น");
        }
      });
    });

    // เปิด modal อัตโนมัติเมื่อมาจาก url parameter
    // ดึง id post จาก URL
    const urlParams = new URLSearchParams(window.location.search);
    const postIdToOpen = urlParams.get("open_post");

    // ถ้ามี id post ที่ต้องการเปิด
    if (postIdToOpen) {
      // ค้นหา modal ที่มี id ตรงกัน
      const modalElement = document.getElementById(
        `fullPostModal${postIdToOpen}`
      );

      if (modalElement) {
        // สร้าง modal bootstrap
        const fullPostModal = new bootstrap.Modal(modalElement);
        fullPostModal.show();

        // ล้าง url parameter ไม่ให้ modal เปิดซ้ำเมื่อ refresh
        const newUrl = window.location.pathname;
        history.replaceState(null, "", newUrl); // แก้ไข url ใน history
      } else {
        // หาก Modal ไม่ถูกพบ
        console.warn(
          `Modal element not found for ID: fullPostModal${postIdToOpen}`
        );
      }
    }
  });
</script>
