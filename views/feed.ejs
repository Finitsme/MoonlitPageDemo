<%- include('partials/header', { title: "‡∏ü‡∏µ‡∏ï‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ | MOONLITPAGE" }) %> 
<%-include('partials/navbar', { user: locals.user }) %>

<main class="container py-5">
  <div class="row">
    
    <div class="col-lg-8">
      <h1 class="mb-4 text-center">Review Feed</h1>

      <% if (user) { %>
      <div class="card mb-4 shadow-sm">
        <div class="card-body">
          <div
            class="input-group"
            data-bs-toggle="modal"
            data-bs-target="#postReviewModal"
            style="cursor: pointer"
          >
            <span class="input-group-text p-0 border-0 bg-transparent me-2">
              <img
                src="<%= user.profile_pic_url || '/images/default_avatar.png' %>"
                alt="Avatar"
                class="rounded-circle"
                style="width: 40px; height: 40px; object-fit: cover"
              />
            </span>
            <input
              type="text"
              class="form-control rounded-pill"
              placeholder="‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î‡∏≠‡∏∞‡πÑ‡∏£‡∏≠‡∏¢‡∏π‡πà, <%= user.username_display || user.fullname || user.username %>?"
              aria-label="New Post"
              readonly
              style="cursor: pointer"
            />
          </div>
        </div>
      </div>
      <% } else { %>
      <p class="alert alert-info text-center">
        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ <a href="/login">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
      </p>
      <% } %>

      <p class="text-muted text-center small mb-5">
        ‡∏î‡∏π‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÉ‡∏ô MoonlitPage
      </p>

      <% if (reviews.length === 0) { %>
      <div class="alert alert-warning text-center">
        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ñ‡∏π‡∏Å‡πÇ‡∏û‡∏™‡∏ï‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì!
      </div>
      <% } else { %> <% reviews.forEach(review => { %> <% const postId =
      review.post_id; const isLiked = review.isLiked || false; const likeCount =
      review.likeCount || 0; const isBookmarked = review.isBookmarked || false;
      %>
      <div class="card mb-3 shadow-sm review-card">
        <div
          class="card-body"
          data-bs-toggle="modal"
          data-bs-target="#fullPostModal<%= postId %>"
          style="cursor: pointer"
        >
          <div class="d-flex align-items-start mb-3">
            <img
              src="<%= review.profile_pic_url || '/images/default_avatar.png' %>"
              alt="Avatar"
              class="rounded-circle me-3"
              style="width: 45px; height: 45px; object-fit: cover"
            />
            <div>
              <h6 class="mb-0">
                <%= review.username_display || review.username %> <% if
                (review.username_display) { %>
                <span class="text-muted small ms-1"
                  >@<%= review.username %></span
                >
                <% } %>
              </h6>
              <p class="text-muted small m-0">
                ‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: <%= new
                Date(review.created_at).toLocaleString('th-TH', { day:
                'numeric', month: 'short', year: 'numeric', hour: '2-digit',
                minute: '2-digit' }) %>
              </p>
            </div>
          </div>

          <p class="card-text review-content mb-3 text-truncate">
            <%= review.content %>
          </p>

          <% if (review.image_url) { %>
          <div class="mb-3">
            <img
              src="<%= review.image_url %>"
              class="img-fluid rounded shadow-sm"
              alt="Review Image"
              style="max-height: 400px; object-fit: cover; width: 100%"
            />
          </div>
          <% } %> <% if (review.bookTitle && review.bookTitle !==
          '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠') { %>
          <div
            class="alert alert-light border-start border-4 border-info p-2 mb-2"
          >
            <i class="fas fa-book me-2 text-info"></i>
            **‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠:**
            <a
              href="/book?q=<%= encodeURIComponent(review.book_id) %>"
              class="text-decoration-none text-info"
            >
              <%= review.bookTitle %>
            </a>
          </div>
          <% } %>
        </div>

        <div class="card-footer bg-white pt-2 pb-2 border-top">
          <div class="d-flex justify-content-between">
            <button
              class="btn btn-sm <%= isLiked ? 'btn-danger' : 'btn-outline-secondary' %> like-button"
              data-post-id="<%= postId %>"
              data-interaction-type="LIKE"
            >
              <i class="fa<%= isLiked ? 's' : 'r' %> fa-heart me-1"></i> 
              <span class="like-count"><%= likeCount %></span>
            </button>

            <button
              class="btn btn-sm btn-outline-secondary text-muted comment-button"
              data-bs-toggle="modal"
              data-bs-target="#fullPostModal<%= postId %>"
            >
              <i class="far fa-comment me-1"></i> ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô (<span
                class="comment-count"
                ><%= review.commentCount %></span
              >)
            </button>

            <button
              class="btn btn-sm <%= isBookmarked ? 'btn-info' : 'btn-outline-secondary' %> bookmark-button"
              data-post-id="<%= postId %>"
              data-interaction-type="BOOKMARK"
            >
              <i class="fa<%= isBookmarked ? 's' : 'r' %> fa-bookmark"></i>
              Bookmark
            </button>
          </div>
        </div>
      </div>
      <% }); %> <% } %>
    </div>
    
    <div class="col-lg-4 d-none d-lg-block">
        <div class="card shadow-sm p-3 sticky-top" style="top: 20px;">
            <h5 class="card-title text-primary mb-3">üèÜ Top 3 ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</h5>
            
            <% if (topPosts && topPosts.length > 0) { %>
                <ul class="list-group list-group-flush">
                    <% topPosts.forEach((post, index) => { %>
                        <li class="list-group-item d-flex justify-content-between align-items-center p-2">
                            <div>
                                <span class="badge <%= index === 0 ? 'bg-warning' : index === 1 ? 'bg-secondary' : 'bg-info' %> me-2">#<%= index + 1 %></span>
                                <a 
                                    href="/feed?open_post=<%= post.post_id %>" 
                                    class="text-decoration-none text-dark"
                                    title="<%= post.content %>"
                                >
                                    <%= post.content.substring(0, 40) %>...
                                </a>
                                <p class="m-0 small text-muted">‡πÇ‡∏î‡∏¢: @<%= post.username_display || post.username %></p>
                            </div>
                            <span class="ms-2">
                                <i class="fas fa-heart text-danger me-1"></i> 
                                <strong class="text-danger"><%= post.likeCount %></strong>
                            </span>
                        </li>
                    <% }); %>
                </ul>
            <% } else { %>
                <p class="text-muted small">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÑ‡∏•‡∏Ñ‡πå‡∏°‡∏≤‡∏Å‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</p>
            <% } %>
        </div>
    </div>
  </div>
</main>

<div class="modal fade" id="postReviewModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏£‡∏µ‡∏ß‡∏¥‡∏ß/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏´‡∏°‡πà</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <form action="/feed/post" method="POST" enctype="multipart/form-data">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label"
              >‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 500 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)</label
            >
            <textarea
              name="content"
              class="form-control"
              rows="4"
              maxlength="500"
              required
            ></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
            <input
              type="file"
              name="review_image"
              class="form-control"
              accept="image/*"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </button>
          <button type="submit" class="btn btn-customfeed">‡πÇ‡∏û‡∏™‡∏ï‡πå</button>
        </div>
      </form>
    </div>
  </div>
</div>

<% reviews.forEach(review => { %> <% const postId = review.post_id; const isLiked = review.isLiked || false; const isBookmarked = review.isBookmarked || false; %>
<div class="modal fade" id="fullPostModal<%= postId %>" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          ‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÇ‡∏î‡∏¢ <%= review.username_display || review.username %>
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div class="d-flex align-items-center mb-3">
          <img
            src="<%= review.profile_pic_url || '/images/default_avatar.png' %>"
            alt="Avatar"
            class="rounded-circle me-3"
            style="width: 40px; height: 40px; object-fit: cover"
          />
          <div>
            <h6 class="mb-0">
              <%= review.username_display || review.username %>
            </h6>
            <p class="text-muted small m-0">
              <%= new Date(review.created_at).toLocaleString('th-TH') %>
            </p>
          </div>
        </div>

        <p class="fs-5"><%= review.content %></p>

        <% if (review.image_url) { %>
        <div class="my-3">
          <img
            src="<%= review.image_url %>"
            class="img-fluid rounded shadow-sm"
            alt="Review Image"
          />
        </div>
        <% } %> <% if (review.bookTitle && review.bookTitle !==
        '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠') { %>
        <div class="alert alert-info p-2 mt-3">
          <i class="fas fa-book me-2"></i>
          **‡∏õ‡πâ‡∏≤‡∏¢‡∏¢‡∏≤:**
          <a
            href="/book?q=<%= encodeURIComponent(review.book_id) %>"
            class="text-decoration-none text-info"
          >
            <%= review.bookTitle %>
          </a>
        </div>
        <% } %>

        <hr />

        <h6>
          ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô (<span id="modalCommentCount<%= postId %>"
            ><%= review.commentCount %></span>)
        </h6>

        <div
          id="commentsList<%= postId %>"
          class="list-group list-group-flush mb-3"
        >
          <% if (review.comments && review.comments.length === 0) { %>
          <div
            class="alert alert-light text-muted small mt-2 no-comments-alert"
          >
            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ô‡∏µ‡πâ
          </div>
          <% } else { %> <% review.comments.forEach(comment => { %>
          <div
            class="list-group-item list-group-item-action p-2 d-flex comment-item"
          >
            <img
              src="<%= comment.profile_pic_url || '/images/default_avatar.png' %>"
              alt="Avatar"
              class="rounded-circle me-2"
              style="width: 30px; height: 30px; object-fit: cover"
            />
            <div>
              <small class="fw-bold text-dark me-1"
                ><%= comment.username_display || comment.username %></small
              >
              <small class="text-muted small"
                ><%= new Date(comment.created_at).toLocaleString('th-TH', {
                dateStyle: 'short', timeStyle: 'short' }) %></small
              >
              <p class="mb-0 small"><%= comment.content %></p>
            </div>
          </div>
          <% }); %> <% } %>
        </div>
        <% if (user) { %>
        <form
          class="d-flex mt-3 comment-form-modal"
          data-post-id="<%= postId %>"
        >
          <input
            type="text"
            class="form-control me-2 comment-input"
            placeholder="‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô..."
          />
          <button class="btn btn-primary" type="submit">‡∏™‡πà‡∏á</button>
        </form>
        <% } %>
      </div>
      <div class="modal-footer justify-content-between">
        <div class="d-flex">
          <button
            class="btn btn-sm <%= isLiked ? 'btn-danger' : 'btn-outline-danger' %> me-2 like-button"
            data-post-id="<%= postId %>"
            data-interaction-type="LIKE"
          >
            <i class="fa<%= isLiked ? 's' : 'r' %> fa-heart me-1"></i> Like
          </button>

          <button
            class="btn btn-sm <%= isBookmarked ? 'btn-info' : 'btn-outline-secondary' %> bookmark-button"
            data-post-id="<%= postId %>"
            data-interaction-type="BOOKMARK"
          >
            <i class="fa<%= isBookmarked ? 's' : 'r' %> fa-bookmark"></i>
            Bookmark
          </button>
        </div>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          ‡∏õ‡∏¥‡∏î
        </button>
      </div>
    </div>
  </div>
</div>
<% }); %> <%- include('partials/footer') %>

<script> 
  document.addEventListener("DOMContentLoaded", () => { 
    // query like-button, bookmark-button
    const actionButtons = document.querySelectorAll(
      ".like-button, .bookmark-button"
    ); 

    // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    actionButtons.forEach((button) => {
      button.addEventListener("click", async function (e) {
        e.preventDefault(); 
        e.stopPropagation(); 

        const type = this.dataset.interactionType; 
        const postId = this.dataset.postId; 
        const partnerButtons = document.querySelectorAll(
          `[data-post-id="${postId}"][data-interaction-type="${type}"]`
        ); 

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ user ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏°‡∏±‡πâ‡∏¢
        if (!"<%= locals.user ? true : false %>") {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ");
          return;
        }

        // LIKE
        if (type === "LIKE") {
          try {
            const response = await fetch("/api/post/like", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ postId: postId }),
            });

            const data = await response.json(); 

            if (data.success) {
              // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ update ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏° like
              partnerButtons.forEach((btn) => {
                const icon = btn.querySelector("i"); 
                const likeCountSpan = btn.querySelector(".like-count"); 

                // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î like ‡πÅ‡∏•‡πâ‡∏ß
                if (data.action === "liked") {
                  btn.classList.remove("btn-outline-secondary", "text-muted");
                  btn.classList.add("btn-danger");
                  icon.classList.remove("far"); 
                  icon.classList.add("fas"); 
                  // update like count +1
                  if (likeCountSpan)
                    likeCountSpan.textContent =
                      parseInt(likeCountSpan.textContent) + 1;
                } else if (data.action === "unliked") { // ‡∏ñ‡πâ‡∏≤ unliked
                  btn.classList.remove("btn-danger", "text-danger");
                  btn.classList.add("btn-outline-secondary", "text-muted");
                  icon.classList.remove("fas"); 
                  icon.classList.add("far"); 
                  // update like count -1
                  if (likeCountSpan)
                    likeCountSpan.textContent =
                      parseInt(likeCountSpan.textContent) - 1;
                }
              });
            } else {
              alert("‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (data.error || "Server error"));
            }
          } catch (error) {
            console.error("Fetch Error:", error);
            alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ");
          }
          return;
        }

        // BOOKMARK
        if (type === "BOOKMARK") {
          try {
            // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏õ‡∏ó‡∏µ‡πà API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö toggle bookmark
            const response = await fetch("/api/post/toggle-bookmark", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ postId: postId }),
            });

            const data = await response.json();

            if (data.success) {
              // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ update ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏° bookmark
              partnerButtons.forEach((btn) => {
                const icon = btn.querySelector("i");
                
                // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î add bookmark ‡πÅ‡∏•‡πâ‡∏ß
                if (data.action === "added") {
                  btn.classList.remove("btn-outline-secondary", "text-muted");
                  btn.classList.add("btn-info");
                  icon.classList.remove("far");
                  icon.classList.add("fas"); 
                  // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î remove bookmark
                } else if (data.action === "removed") {
                  btn.classList.remove("btn-info");
                  btn.classList.add("btn-outline-secondary", "text-muted");
                  icon.classList.remove("fas");
                  icon.classList.add("far"); 
                }
              });
            } else {
              alert(
                "‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ Bookmark ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " +
                  (data.error || "Server error")
              );
            }
          } catch (error) {
            console.error("Bookmark Fetch Error:", error);
            alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ");
          }
          return;
        }
      });
    });

    // COMMENT
    document.querySelectorAll(".comment-form-modal").forEach((form) => { 
      form.addEventListener("submit", async function (e) {
        e.preventDefault(); 

        const postId = this.dataset.postId; 
        const contentInput = this.querySelector(".comment-input"); 
        const content = contentInput.value.trim(); 

        if (!content) return; 

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ user ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏°‡∏±‡πâ‡∏¢
        if (!"<%= locals.user ? true : false %>") {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô");
          return;
        }

        try {
          // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏õ‡∏ó‡∏µ‡πà API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö comment
          const response = await fetch("/api/post/comment", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ postId: postId, content: content }),
          });

          const data = await response.json();

          if (data.success) {
            const commentsList = document.getElementById(
              `commentsList${postId}` 
            );
            const modalCountSpan = document.getElementById(
              `modalCommentCount${postId}` 
            );
            const feedCountSpans = document.querySelectorAll(
              `.review-card [data-post-id="${postId}"] .comment-count` 
            );

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á comment 
            const newComment = data.newComment;
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö comment ‡πÉ‡∏´‡∏°‡πà
            const newCommentHtml = ` 
                            <div class="list-group-item list-group-item-action p-2 d-flex comment-item">
                                <img 
                                    src="${
                                      newComment.profile_pic_url ||
                                      "/images/default_avatar.png"
                                    }" 
                                    alt="Avatar" 
                                    class="rounded-circle me-2" 
                                    style="width: 30px; height: 30px; object-fit: cover;"
                                />
                                <div>
                                    <small class="fw-bold text-dark me-1">${
                                      newComment.username_display ||
                                      newComment.username
                                    }</small>
                                    <small class="text-muted small">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</small>
                                    <p class="mb-0 small">${
                                      newComment.content
                                    }</p>
                                </div>
                            </div>
                        `;

            // ‡∏•‡∏ö alert "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô" 
            const noCommentAlert =
              commentsList.querySelector(".no-comments-alert");
            if (noCommentAlert) noCommentAlert.remove();

            // ‡πÄ‡∏û‡∏¥‡πà‡∏° comment ‡πÉ‡∏´‡∏°‡πà
            commentsList.insertAdjacentHTML("beforeend", newCommentHtml);

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Comment
            if (modalCountSpan) 
              modalCountSpan.textContent = data.newCommentCount;
            feedCountSpans.forEach( 
              (span) => (span.textContent = data.newCommentCount)
            );

            // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå Input
            contentInput.value = "";
          } else {
            alert(
              "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÑ‡∏î‡πâ: " + (data.error || "Server error")
            );
          }
        } catch (error) {
          console.error("Comment Submit Error:", error);
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô");
        }
      });
    });

    // ‡πÄ‡∏õ‡∏¥‡∏î modal ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏≤‡∏à‡∏≤‡∏Å url parameter
    // ‡∏î‡∏∂‡∏á id post ‡∏à‡∏≤‡∏Å URL
    const urlParams = new URLSearchParams(window.location.search);
    const postIdToOpen = urlParams.get("open_post");

    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ id post ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î
    if (postIdToOpen) {
      // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ modal ‡∏ó‡∏µ‡πà‡∏°‡∏µ id ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
      const modalElement = document.getElementById(
        `fullPostModal${postIdToOpen}`
      );

      if (modalElement) {
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á modal bootstrap
        const fullPostModal = new bootstrap.Modal(modalElement);
        fullPostModal.show();

        // ‡∏•‡πâ‡∏≤‡∏á url parameter ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ modal ‡πÄ‡∏õ‡∏¥‡∏î‡∏ã‡πâ‡∏≥‡πÄ‡∏°‡∏∑‡πà‡∏≠ refresh
        const newUrl = window.location.pathname;
        history.replaceState(null, "", newUrl); // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç url ‡πÉ‡∏ô history
      } else {
        // ‡∏´‡∏≤‡∏Å Modal ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏û‡∏ö
        console.warn(
          `Modal element not found for ID: fullPostModal${postIdToOpen}`
        );
      }
    }
  });
</script>